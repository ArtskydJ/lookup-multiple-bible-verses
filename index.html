<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Lookup Multiple Bible Verses</title>
	<style type="text/css">
		html, body, textarea {
			margin: 0;
			padding: 0;
			font-family: calibri, sans-serif;
		}
		textarea, .verse {
			margin: 0.5em;
		}
		textarea {
			width: calc(100vw - 1em);
			border: 0;
			resize: vertical;
			display: inline-block;
			outline: 1px solid #68d;
		}
		textarea:focus-visible {
			box-shadow: #68d 4px 4px 4px;
		}
		.output {
		}
		.verse {
			background-color: #eee;
			display: inline-block;
			padding: 0.5em;
			box-shadow: #aaa 4px 4px 4px;
		}
		.ref {
			padding: 0.2em 0.3em;
			background-color: #ccc;
			display: inline-block;
			margin-right: 1em;
		}
	</style>
</head>
<body>
	<textarea autofocus></textarea>
	<div class="output"></div>
	<script src="https://www.canonapi.com/v1client.js"></script>
	<script type="text/javascript">
		const textarea = document.querySelector('textarea')
		const output = document.querySelector('div.output')

		function refresh() {
			Promise.all(
				textarea.value
					.split('\n')
					.filter(ref => ref.trim())
					.map(ref => {
						const matches = /(\d*\D+)(\d+)(?:\D+(\d+)(?:\D+(\d+))?)?/.exec(ref)
						if (matches) {
							const [ , book, chapter, start_verse, end_verse ] = matches.map(match => isNaN(Number(match)) ? match : Math.max(Number(match), 1))
							return window.canonapiv1client(book, chapter)
								.then(({ verses, book_name }) => {
									const slice_start = start_verse ? start_verse - 1 : 0
									const slice_end = (end_verse || start_verse || Infinity)
									const pretty_book_chapter = `${book_name} ${chapter}`
									const pretty_verse = start_verse ? start_verse + (end_verse ? '-' + Math.min(end_verse, verses.length) : '') : ''
									const pretty_ref = [ pretty_book_chapter, pretty_verse ].filter(Boolean).join(':')
									const text = verses.slice(slice_start, slice_end).join('')
									return `<span class="verse"><span class="ref">${pretty_ref}</span>${text}</span>`
								})
								.catch(e => `<span class="err">${e.message}</span>`)
						}
					})
			).then(html => output.innerHTML = html.filter(Boolean).join(''))
		}

		textarea.oninput = refresh

		refresh()
	</script>
</body>
</html>
